<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0px; padding: 0px }
      #container { width: 100%; height: 100% }
      #nav { z-index: 100; position: absolute; 
             margin: 10px 0px 0px 200px; background-color: #fff; 
             border: 1px #000 Solid; padding: 5px; }
      #map { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="nav">Nav Menu</div>
      <div id="map"></div>
    </div>
    <script>
      function initMap(map) {
        var uluru = {lat: -25.363, lng: 131.044};
        var paris = {lat: 48.8566, lng: 2.3522};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: paris
        });
        var marker = new google.maps.Marker({
          position: uluru,
          map: map
        });
        populateMap(map);
      }

      function populateMap(map){
        $.getJSON('http://127.0.0.1:3000/stations', function(data){
          console.log(data);
          var markers = [];
          var infowindow = new google.maps.InfoWindow({
              content: 'Chargement...'
            })
          for(var i = 0; i<data.length;i++){
            //console.log(data[i].lonlat[0])
            var prices = '<ul>'
            for(key in data[i].prices){
              prices += '<li>'+data[i].prices[key].name + ' : <b>' + data[i].prices[key].value + " €</b></li>"
            }
            prices+='</ul>'

            var services = '<ul>'
            for(var j=0; j<data[i].services.length;j++){
              services += '<li>'+data[i].services[j]+"</li>"
            }
            services+='</ul>'

            var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            //'<h1 id="firstHeading" class="firstHeading">'+data[i].address + ", " + data[i].postcode + " " + data[i].city+'</h1>'+
            '<div id="bodyContent">'+
            '<h2>Adresse</h2>'+
            '<p>'+data[i].address + ",<br />"+ data[i].postcode + " " + data[i].city+'</p>'+
            '<h2>Horaires</h2><ul><li>Ouverture : '+data[i].hours.open+'</li>'+
            '<li>Fermeture : '+data[i].hours.close+'</li></ul>'+
            '<h2> Prix </h2>'+ prices +
            '<h2> Services </h2>'+ services +
            //'<p> Données au ' + Date.parse(data[i].last_modified) + '</p>'+
            '</div>'+
            '</div>';

            var marker = new google.maps.Marker({
              position: {lat:parseFloat(data[i].lonlat[1]),lng:parseFloat(data[i].lonlat[0])},
              map: map,
              title: data[i].address + ", " + data[i].postcode + " " + data[i].city,
              html: contentString
            });

            markers.push(marker);

            google.maps.event.addListener(marker, 'click', function () {
              infowindow.setContent(this.html);
              infowindow.open(map, this);
            });
          }

        });
      }
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    </script>
    <script async defer src="./loadGoogleMaps.js">
    </script>
  </body>
</html>